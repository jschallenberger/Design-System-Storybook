name: Test Storybook

on:
  workflow_dispatch:
    inputs:
      input:
        description: "Test"
        required: false
        default: "test"

jobs:
  run-tests:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=6144
      GH_TOKEN: ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}
      
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup NodeJS
      uses: actions/setup-node@v3
      with:
        node-version: 16
    
    - name: Install dependencies w/o changing -lock.json
      run: npm ci --legacy-peer-deps

    - name: Build
      run: npm run build-storybook

    - name: Test  
      uses: Eun/http-server-action@v1
      with:
        directory: ${{ github.workspace }}/storybook-static
        port: 6006
        no-cache: false
        index-files: |
         ["index.html", "index.htm"]
        allowed-methods: | 
          ["GET", "HEAD","POST"]
        content-types: |
          {
            "appcache": "text/cache-manifest",
            "css": "text/css",
            "gif": "image/gif",
            "html": "text/html",
            "ico": "image/x-icon",
            "jpeg": "image/jpeg",
            "jpg": "image/jpeg",
            "js": "text/javascript",
            "json": "application/json",
            "png": "image/png",
            "txt": "text/plain",
            "xml": "text/xml",
            "svg": "image/svg+xml"
          }

    - uses: ifaxity/wait-on-action
      with:
        resource: http://localhost:6006

    - name: Run tests
      run: npm run test-storybook -- --ci